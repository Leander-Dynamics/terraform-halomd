trigger:
  branches: { include: [ main ] }

variables:
- group: terraform-global-common
- group: terraform-dev

pool:
  vmImage: ubuntu-latest

stages:
- stage: Dev
  displayName: "Terraform: Dev"
  jobs:
  - job: PlanAndApply_Dev
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform init/plan/apply (Dev)"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: "$(System.DefaultWorkingDirectory)/platform/infra/envs/$(ENV_NAME)"
        inlineScript: |
          set -euo pipefail
          echo "Azure Subscription: $(AZ_SUBSCRIPTION_ID)"
          az account set --subscription "$(AZ_SUBSCRIPTION_ID)"

          # Fail-fast conflict guards
          if grep -R --include="*.tf" --exclude-dir=".terraform" "new-terraform-modules" -n "$(System.DefaultWorkingDirectory)"; then echo "ERROR: legacy 'new-terraform-modules' present"; exit 1; fi
          if grep -R --include="*.tf" --exclude-dir=".terraform" "arbit_workflow" -n "$(System.DefaultWorkingDirectory)"; then echo "ERROR: old module name 'arbit_workflow' present"; exit 1; fi
          if grep -R --include="*.tf" --exclude-dir=".terraform" "/modules/aks" -n "$(System.DefaultWorkingDirectory)" || grep -R --include="*.tf" --exclude-dir=".terraform" "/modules/acr" -n "$(System.DefaultWorkingDirectory)"; then echo "ERROR: AKS/ACR modules present"; exit 1; fi

          terraform fmt -recursive
          terraform init -backend-config=backend.tfvars
          terraform validate
          terraform plan  -var-file=terraform.tfvars -out=tfplan -lock-timeout=$(TF_LOCK_TIMEOUT)s
          terraform apply -auto-approve tfplan     -lock-timeout=$(TF_LOCK_TIMEOUT)s